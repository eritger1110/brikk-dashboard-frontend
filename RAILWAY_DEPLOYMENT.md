# Railway Deployment Guide - Brikk Dashboard

## Prerequisites

✅ Railway project already connected: `api.getbrikk.com`
✅ GitHub repository connected to Railway
✅ Render Postgres database provisioned
✅ All environment variables configured in Manus

## Environment Variables Required in Railway

Configure these in Railway Dashboard → Project → Variables:

### Database
```
DATABASE_URL=postgresql://brikk_db_user:T45WUkIuyq2JhqjwJeMDTYTHqmuZjR5j@dpg-d3aun10dl3ps738vbalg-a.oregon-postgres.render.com/brikk_db?sslmode=require
```

### Auth0
```
VITE_AUTH0_DOMAIN=brikk-dashboard.us.auth0.com
VITE_AUTH0_CLIENT_ID=Loc1sTGoiYMD5hXrLPwoLlReHOEIllGo
VITE_AUTH0_AUDIENCE=https://api.getbrikk.com
AUTH0_CLIENT_SECRET=<from Manus secrets>
AUTH0_MANAGEMENT_API_TOKEN=<from Manus secrets>
```

### Encryption & Security
```
ENCRYPTION_MASTER_KEY=<from Manus secrets>
JWT_SECRET=<auto-generated or from Manus>
```

### AWS Services
```
AWS_ACCESS_KEY_ID=<from Manus secrets>
AWS_SECRET_ACCESS_KEY=<from Manus secrets>
AWS_REGION=us-east-1
```

### AWS SES (Email)
```
SES_REGION=us-east-1
SES_FROM_ADDRESS=no-reply@getbrikk.com
SES_SUPPORT_ADDRESS=support@getbrikk.com
SES_SECURITY_ADDRESS=security@getbrikk.com
SES_CONNECT_ADDRESS=connect@getbrikk.com
```

### Application
```
NODE_ENV=production
PORT=3000
```

## Deployment Steps

### 1. Push to GitHub

```bash
cd /home/ubuntu/brikk-rules-dashboard
git add .
git commit -m "Production backend with tRPC API, security, and database integration"
git push origin main
```

### 2. Railway Auto-Deployment

Railway will automatically:
1. Detect the push to `main` branch
2. Build using nixpacks (Node.js 22)
3. Run `pnpm install`
4. Execute `pnpm run build`
5. Start server with `pnpm run start`
6. Expose on `api.getbrikk.com`

### 3. Verify Deployment

**Health Check:**
```bash
curl https://api.getbrikk.com/
```

**tRPC API:**
```bash
curl https://api.getbrikk.com/api/trpc/agents.list
```

**Expected Response:** 401 Unauthorized (correct - needs authentication)

### 4. Monitor Logs

Railway Dashboard → Project → Deployments → View Logs

Look for:
```
Server running on http://localhost:3000/
```

## Build Configuration

### package.json Scripts

```json
{
  "scripts": {
    "build": "vite build && tsc --project tsconfig.server.json",
    "start": "NODE_ENV=production node dist/server/index.js",
    "dev": "tsx watch server/index.ts"
  }
}
```

### Railway Configuration (railway.toml)

```toml
[build]
builder = "nixpacks"

[deploy]
startCommand = "pnpm run build && pnpm run start"
healthcheckPath = "/"
healthcheckTimeout = 100
restartPolicyType = "on-failure"
restartPolicyMaxRetries = 10
```

## Database Migration

Database schema is already created in Render Postgres (51 tables). No migrations needed.

To verify:
```bash
# From Railway logs, you should see successful database connection
# No errors about missing tables
```

## Security Checklist

- ✅ All secrets stored in Railway environment variables (not in code)
- ✅ HTTPS enforced (Railway automatic)
- ✅ CORS configured for frontend domain
- ✅ Rate limiting active (100 req/min per IP)
- ✅ Security headers (CSP, HSTS, X-Frame-Options)
- ✅ Audit logging enabled
- ✅ API key hashing with PBKDF2
- ✅ Data encryption ready (AES-256-GCM)

## Troubleshooting

### Build Fails

**Check:**
1. All dependencies in `package.json`
2. TypeScript compilation errors
3. Railway build logs

**Fix:**
```bash
# Test build locally
pnpm run build
```

### Server Won't Start

**Check:**
1. `DATABASE_URL` is set correctly
2. Port 3000 is not hardcoded (use `process.env.PORT`)
3. All required environment variables present

**Fix:**
```bash
# Test locally with production env
NODE_ENV=production pnpm run start
```

### Database Connection Fails

**Check:**
1. `DATABASE_URL` format: `postgresql://user:pass@host:port/db?sslmode=require`
2. Render Postgres is running
3. SSL mode is `require`

**Fix:**
- Verify connection string in Render dashboard
- Test connection with `psql` command

### tRPC Endpoints Return 404

**Check:**
1. Server is mounting tRPC at `/api/trpc`
2. Frontend is calling correct URL
3. CORS is configured

**Fix:**
```typescript
// server/index.ts
app.use("/api/trpc", createExpressMiddleware({
  router: appRouter,
  createContext,
}));
```

## Post-Deployment

### 1. Update Frontend

Update `VITE_API_BASE_URL` in Netlify to point to Railway:
```
VITE_API_BASE_URL=https://api.getbrikk.com
```

### 2. Test Authentication

1. Login via frontend
2. Check Auth0 callback works
3. Verify JWT token in requests

### 3. Monitor Performance

Railway Dashboard → Metrics:
- CPU usage
- Memory usage
- Response times
- Error rates

### 4. Set Up Alerts

Railway Dashboard → Settings → Notifications:
- Deployment failures
- High error rates
- Resource limits

## Scaling

### Horizontal Scaling

Railway Pro plan supports:
- Multiple instances
- Load balancing
- Auto-scaling

### Database Scaling

Render Postgres:
- Upgrade plan for more connections
- Add read replicas
- Enable connection pooling

## Backup & Recovery

### Database Backups

Render Postgres:
- Automatic daily backups (7-day retention)
- Manual backup: Render Dashboard → Database → Backup

### Code Rollback

Railway:
- Dashboard → Deployments → Previous deployment → Redeploy
- Or: `git revert` + push

## Support

- **Railway Issues:** https://railway.app/help
- **Render Issues:** https://render.com/docs
- **Auth0 Issues:** https://auth0.com/docs

## Next Steps

1. ✅ Deploy backend to Railway
2. ⏳ Update frontend to call Railway backend
3. ⏳ Set up CI/CD with GitHub Actions
4. ⏳ Configure monitoring and alerts
5. ⏳ Run penetration testing
6. ⏳ Complete SOC 2 audit preparation
